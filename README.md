# BÃO CÃO Dá»° ÃN: SMART MATH - á»¨NG Dá»¤NG Há»ŒC TOÃN THÃ”NG MINH

---

## 1. GIá»šI THIá»†U Váº¤N Äá»€

### 1.1. Bá»‘i cáº£nh

Trong thá»i Ä‘áº¡i cÃ´ng nghá»‡ 4.0, viá»‡c á»©ng dá»¥ng cÃ´ng nghá»‡ vÃ o giÃ¡o dá»¥c Ä‘ang trá»Ÿ thÃ nh xu hÆ°á»›ng táº¥t yáº¿u. Viá»‡c há»c toÃ¡n - mÃ´n há»c ná»n táº£ng quan trá»ng - thÆ°á»ng gáº·p nhá»¯ng khÃ³ khÄƒn nhÆ°:

- **Thiáº¿u tÃ­nh tÆ°Æ¡ng tÃ¡c**: PhÆ°Æ¡ng phÃ¡p há»c truyá»n thá»‘ng qua sÃ¡ch vá»Ÿ khiáº¿n há»c sinh dá»… cáº£m tháº¥y nhÃ m chÃ¡n
- **KhÃ´ng tÃ¹y chá»‰nh theo trÃ¬nh Ä‘á»™**: CÃ¡c bÃ i táº­p thÆ°á»ng cÃ³ Ä‘á»™ khÃ³ cá»‘ Ä‘á»‹nh, khÃ´ng phÃ¹ há»£p vá»›i má»i Ä‘á»‘i tÆ°á»£ng
- **Thiáº¿u Ä‘á»™ng lá»±c há»c táº­p**: Há»c sinh khÃ´ng cÃ³ pháº£n há»“i tá»©c thÃ¬ vÃ  thiáº¿u yáº¿u tá»‘ khuyáº¿n khÃ­ch

### 1.2. Má»¥c tiÃªu dá»± Ã¡n

**Smart Math** Ä‘Æ°á»£c phÃ¡t triá»ƒn nháº±m giáº£i quyáº¿t cÃ¡c váº¥n Ä‘á» trÃªn thÃ´ng qua má»™t á»©ng dá»¥ng game há»c toÃ¡n vá»›i cÃ¡c má»¥c tiÃªu cá»¥ thá»ƒ:

âœ… **TÄƒng tÃ­nh tÆ°Æ¡ng tÃ¡c**: Giao diá»‡n game hÃ³a, Ã¢m thanh sá»‘ng Ä‘á»™ng  
âœ… **PhÃ¢n cáº¥p Ä‘á»™ khÃ³**: 6 cáº¥p Ä‘á»™ tá»« cÆ¡ báº£n Ä‘áº¿n nÃ¢ng cao  
âœ… **Táº¡o Ä‘á»™ng lá»±c**: Há»‡ thá»‘ng Ä‘iá»ƒm sá»‘, sao, vÃ  thá»i gian táº¡o thá»­ thÃ¡ch  
âœ… **Luyá»‡n táº­p Ä‘a dáº¡ng**: Bao gá»“m cá»™ng trá»« nhÃ¢n chia, phÃ¢n sá»‘, tÃ¬m X, vÃ  phÆ°Æ¡ng trÃ¬nh

### 1.3. Äá»‘i tÆ°á»£ng sá»­ dá»¥ng

- Há»c sinh tiá»ƒu há»c (lá»›p 1-5): Level 1-3
- Há»c sinh THCS (lá»›p 6-9): Level 4-6
- NgÆ°á»i muá»‘n rÃ¨n luyá»‡n tÆ° duy toÃ¡n há»c

### 1.4. CÃ´ng nghá»‡ sá»­ dá»¥ng

| CÃ´ng nghá»‡ | PhiÃªn báº£n | Má»¥c Ä‘Ã­ch sá»­ dá»¥ng |
|-----------|-----------|------------------|
| **Python** | 3.x | NgÃ´n ngá»¯ láº­p trÃ¬nh chÃ­nh |
| **Pygame** | 2.x | Framework phÃ¡t triá»ƒn game 2D, xá»­ lÃ½ Ä‘á»“ há»a vÃ  Ã¢m thanh |
| **Pillow** | 10.x | Xá»­ lÃ½ vÃ  render áº£nh GIF animation |
| **JSON** | Built-in | LÆ°u trá»¯ dá»¯ liá»‡u Ä‘iá»ƒm sá»‘ vÃ  tiáº¿n trÃ¬nh (save.json) |
| **Fractions** | Built-in | Xá»­ lÃ½ phÃ¢n sá»‘ trong Level 5-6 (tá»± Ä‘á»™ng rÃºt gá»n) |
| **Random** | Built-in | Táº¡o cÃ¢u há»i ngáº«u nhiÃªn vÃ  trá»™n Ä‘Ã¡p Ã¡n |
| **Time** | Built-in | Quáº£n lÃ½ bá»™ Ä‘áº¿m thá»i gian realtime |
| **OS** | Built-in | Xá»­ lÃ½ Ä‘Æ°á»ng dáº«n file cross-platform |
| **Math** | Built-in | TÃ­nh toÃ¡n GCD (Greatest Common Divisor) |

### 1.5. Cáº¥u trÃºc dá»± Ã¡n

```
Du-an-phan-mem-hoc-tap-Smart-Math/
â”‚
â”œâ”€â”€ ğŸ“„ main.py                       # File khá»Ÿi cháº¡y chÃ­nh
â”œâ”€â”€ ğŸ“„ requirements.txt              # Danh sÃ¡ch thÆ° viá»‡n (pygame, Pillow)
â”œâ”€â”€ ğŸ“„ README.md                     # BÃ¡o cÃ¡o dá»± Ã¡n
â”‚
â”œâ”€â”€ ğŸ“ src/                          # MÃ£ nguá»“n chÃ­nh
â”‚   â”œâ”€â”€ ğŸ“„ config.py                 # Cáº¥u hÃ¬nh toÃ n cá»¥c
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ core/                     # LÃµi xá»­ lÃ½ game
â”‚   â”‚   â”œâ”€â”€ game_manager.py          # Bá»™ nÃ£o Ä‘iá»u khiá»ƒn game (67 dÃ²ng)
â”‚   â”‚   â””â”€â”€ load_sounds.py           # Load Ã¢m thanh
â”‚   â”‚
â”‚   â”œâ”€â”€ ğŸ“ screens/                  # CÃ¡c mÃ n hÃ¬nh
â”‚   â”‚   â”œâ”€â”€ base_screen.py           # Lá»›p cÆ¡ sá»Ÿ
â”‚   â”‚   â”œâ”€â”€ home_screen.py           # MÃ n hÃ¬nh chÃ o má»«ng
â”‚   â”‚   â”œâ”€â”€ level_select_screen.py  # MÃ n chá»n level (263 dÃ²ng)
â”‚   â”‚   â”œâ”€â”€ gameplay_screen.py       # MÃ n chÆ¡i chÃ­nh (668 dÃ²ng)
â”‚   â”‚   â””â”€â”€ menu_screen.py           # Popup cÃ i Ä‘áº·t (157 dÃ²ng)
â”‚   â”‚
â”‚   â””â”€â”€ ğŸ“ effects/                  # Hiá»‡u á»©ng Ä‘á»“ há»a (9 files)
â”‚       â”œâ”€â”€ animation_utils.py       # Tiá»‡n Ã­ch animation
â”‚       â”œâ”€â”€ base_effect.py           # Lá»›p cÆ¡ sá»Ÿ effect
â”‚       â”œâ”€â”€ button_effects.py        # Hiá»‡u á»©ng nÃºt báº¥m
â”‚       â”œâ”€â”€ effect_manager.py        # Quáº£n lÃ½ effects
â”‚       â”œâ”€â”€ gif_animation.py         # Xá»­ lÃ½ GIF animation
â”‚       â”œâ”€â”€ progress_effects.py      # Hiá»‡u á»©ng thanh tiáº¿n Ä‘á»™
â”‚       â””â”€â”€ transitions.py           # Chuyá»ƒn cáº£nh
â”‚
â”œâ”€â”€ ğŸ“ data/                         # Dá»¯ liá»‡u game
â”‚   â”œâ”€â”€ questions.py                 # Generator cÃ¢u há»i 6 level (391 dÃ²ng)
â”‚   â”œâ”€â”€ save_manager.py              # LÆ°u/táº£i JSON (35 dÃ²ng)
â”‚   â””â”€â”€ save.json                    # File lÆ°u Ä‘iá»ƒm (tá»± Ä‘á»™ng táº¡o)
â”‚
â””â”€â”€ ğŸ“ assets/                       # TÃ i nguyÃªn
    â”œâ”€â”€ ğŸ“ fonts/                    # 4 font chá»¯
    â”œâ”€â”€ ğŸ“ images/                   # 40 hÃ¬nh áº£nh PNG/GIF
    â””â”€â”€ ğŸ“ sounds/                   # 4 file Ã¢m thanh MP3
```

**Thá»‘ng kÃª:**
- **Tá»•ng sá»‘ file Python**: 19 files (~1,581 dÃ²ng code chÃ­nh)
- **Tá»•ng tÃ i nguyÃªn**: 48 files (4 fonts + 40 images + 4 sounds)
- **File phá»©c táº¡p nháº¥t**: `gameplay_screen.py` (668 dÃ²ng)
---

## 2. CÃC MODULE CHÃNH

Dá»± Ã¡n Ä‘Æ°á»£c tá»• chá»©c thÃ nh 9 module chÃ­nh, má»—i module Ä‘áº£m nhiá»‡m má»™t chá»©c nÄƒng cá»¥ thá»ƒ:

| Module | File | DÃ²ng code | Chá»©c nÄƒng chÃ­nh |
|--------|------|-----------|-----------------|
| **Game Manager** | `src/core/game_manager.py` | 67 | Bá»™ nÃ£o Ä‘iá»u khiá»ƒn toÃ n bá»™ luá»“ng game, quáº£n lÃ½ chuyá»ƒn mÃ n hÃ¬nh |
| **Effect Manager** | `src/effects/effect_manager.py` | 439 | Quáº£n lÃ½ hiá»‡u á»©ng chuyá»ƒn cáº£nh (fade, slide, zoom transitions) |
| **Questions Generator** | `data/questions.py` | 391 | Táº¡o cÃ¢u há»i ngáº«u nhiÃªn cho 6 cáº¥p Ä‘á»™ |
| **Gameplay Screen** | `src/screens/gameplay_screen.py` | 668 | MÃ n hÃ¬nh chÆ¡i chÃ­nh - phá»©c táº¡p nháº¥t trong dá»± Ã¡n |
| **Level Select Screen** | `src/screens/level_select_screen.py` | 263 | MÃ n hÃ¬nh chá»n level vá»›i logic khÃ³a |
| **Home Screen** | `src/screens/home_screen.py` | 54 | MÃ n hÃ¬nh chÃ o má»«ng vá»›i nÃºt báº¯t Ä‘áº§u |
| **Menu Screen** | `src/screens/menu_screen.py` | 157 | Popup cÃ i Ä‘áº·t overlay (khÃ´ng pháº£i mÃ n hÃ¬nh Ä‘á»™c láº­p) |
| **Save Manager** | `data/save_manager.py` | 35 | LÆ°u vÃ  táº£i dá»¯ liá»‡u JSON |
| **Load Sounds** | `src/core/load_sounds.py` | 17 | Load Ã¢m thanh vÃ o bá»™ nhá»› (click, yes, no, bgm) |

**Tá»•ng cá»™ng**: ~2,091 dÃ²ng code logic chÃ­nh

---

### 2.1. Module Game Manager (`src/core/game_manager.py`)

**Vai trÃ²**: Bá»™ nÃ£o trung tÃ¢m Ä‘iá»u khiá»ƒn toÃ n bá»™ luá»“ng game

#### Chá»©c nÄƒng chÃ­nh:

```python
class GameManager:
    sounds = _load_sound()  # Load sounds trÆ°á»›c khi khá»Ÿi táº¡o
    
    def __init__(self):        
        # Khá»Ÿi táº¡o 3 mÃ n hÃ¬nh chÃ­nh
        self.screens = {
            "HOME": HomeScreen(self),
            "LEVEL": LevelSelectScreen(self),
            "GAMEPLAY": GameplayScreen(self),
        }
        
        # MÃ n hÃ¬nh hiá»‡n táº¡i
        self.active_screen_key = "HOME"
        self.active_screen = self.screens[self.active_screen_key]
        self.current_level_key = None  # Level Ä‘Ã£ chá»n (VD: "LEVEL_1")
        
        # Menu Settings (popup, khÃ´ng pháº£i screen)
        self.menu = MenuScreen(self)
        
        # Táº£i dá»¯ liá»‡u Ä‘iá»ƒm vÃ  sao Ä‘Ã£ lÆ°u
        self.game_data = load_game_data()
        
        # PhÃ¡t nháº¡c ná»n láº·p láº¡i
        pygame.mixer.music.play(loops=-1)
        
        # Bá»™ cÃ¢u há»i cho level hiá»‡n táº¡i
        self.questions_pool = [] 
        self.question_index = 0
```

**Giáº£i thÃ­ch**:
- `menu`: MenuScreen lÃ  POPUP overlay, khÃ´ng pháº£i mÃ n hÃ¬nh Ä‘á»™c láº­p
- `sounds`: ÄÆ°á»£c load á»Ÿ class level, dÃ¹ng chung cho toÃ n bá»™ game
- `questions_pool`: Chá»©a 20 cÃ¢u há»i Ä‘Æ°á»£c táº¡o khi chá»n level

#### Chuyá»ƒn mÃ n hÃ¬nh vÃ  táº¡o cÃ¢u há»i:

```python
def switch_screen(self, screen_key):
    if screen_key in self.screens:
        # Khi chuyá»ƒn Ä‘áº¿n mÃ n hÃ¬nh chÆ¡i, táº¡o cÃ¢u há»i
        if screen_key == "GAMEPLAY" and self.current_level_key:
            generator = QUESTION_GENERATORS.get(self.current_level_key)
            if generator:
                # Táº¡o 20 cÃ¢u há»i ngáº«u nhiÃªn
                generated_questions = generator(MAX_QUESTIONS)
                self.questions_pool = generated_questions
                self.question_index = 0
            else:
                print(f"KhÃ´ng tÃ¬m tháº¥y generator cho level: {self.current_level_key}")
                self. = []
                
            # Gá»i on_enter() Ä‘á»ƒ reset tráº¡ng thÃ¡i gameplay
            self.screens[screen_key].on_enter()
                
        self.active_screen_key = screen_key
        self.active_screen = self.screens[self.active_screen_key]
```

**Äiá»ƒm quan trá»ng**:
- Generator Ä‘Æ°á»£c láº¥y tá»« dictionary `QUESTION_GENERATORS` trong `questions.py`
- `on_enter()` Ä‘Æ°á»£c gá»i Ä‘á»ƒ reset Ä‘iá»ƒm, timer, vÃ  load cÃ¢u há»i Ä‘áº§u tiÃªn

---

### 2.2. Module Questions Generator (`data/questions.py`)

**Vai trÃ²**: Táº¡o cÃ¢u há»i toÃ¡n há»c ngáº«u nhiÃªn cho 6 cáº¥p Ä‘á»™

#### Cáº¥u trÃºc Level:

Má»—i cÃ¢u há»i Ä‘Æ°á»£c tráº£ vá» dáº¡ng dictionary:

```python
{
    "prefix": "HÃ£y thá»±c hiá»‡n phÃ©p toÃ¡n sau:",  # TiÃªu Ä‘á» cÃ¢u há»i
    "question": "45 + 67 = ?",                 # Ná»™i dung cÃ¢u há»i
    "options": [112, 100, 120, 95],            # 4 Ä‘Ã¡p Ã¡n (Ä‘Ã£ shuffle)
    "answer": 112                               # ÄÃ¡p Ã¡n Ä‘Ãºng
}
```

#### Level 1 - Cá»™ng Trá»« vá»›i Ä‘á»™ khÃ³ tÄƒng dáº§n

```python
def get_level_1_questions(num_questions=20):
    questions = []
    prefix = "HÃ£y thá»±c hiá»‡n phÃ©p toÃ¡n sau:"
    
    for i in range(num_questions):
        # Äá»™ khÃ³ tÄƒng dáº§n theo chá»‰ sá»‘
        if i < 10:
            a = random.randint(1, 20)
            b = random.randint(1, 20)
            max_for_options = 50
        elif i >= 10 and i < 17:
            a = random.randint(10, 25)
            b = random.randint(10, 25)
            max_for_options = 70
        else:
            a = random.randint(40, 99)
            b = random.randint(40, 99)
            max_for_options = 200
            
        if random.choice([True, False]):
            question_content = f"{a} + {b} = ?"
            correct_answer = a + b
        else:
            # Äáº£m báº£o káº¿t quáº£ khÃ´ng Ã¢m
            if a < b:
                a, b = b, a
            question_content = f"{a} - {b} = ?"
            correct_answer = a - b
        
        options = _create_options(correct_answer, min_val=0, max_val=max_for_options)
        
        questions.append({
            "prefix": prefix,
            "question": question_content,
            "options": options,
            "answer": correct_answer
        })
    return questions
```

**Äiá»ƒm ná»•i báº­t**:
- CÃ¢u Ä‘áº§u dá»… (1-20), cÃ ng vá» sau cÃ ng khÃ³ (Ä‘áº¿n 40-99)
- Äáº£m báº£o káº¿t quáº£ phÃ©p trá»« khÃ´ng Ã¢m báº±ng cÃ¡ch swap `a` vÃ  `b`

#### Level 5 - PhÃ¢n sá»‘ vá»›i `answer_index`

```python
def get_level_5_questions(num_questions=20):
    questions = []
    for _ in range(num_questions):
        type_q = random.choice(["rutgon", "cong", "tru", "nhan", "chia"])
        
        if type_q == "cong":
            f1 = Fraction(random.randint(1, 12), random.randint(2, 12))
            f2 = Fraction(random.randint(1, 12), random.randint(2, 12))
            result = f1 + f2  # Python tá»± quy Ä‘á»“ng vÃ  rÃºt gá»n
            question_content = f"{f1.numerator}/{f1.denominator} + {f2.numerator}/{f2.denominator} = ?"
            correct_str = f"{result.numerator}/{result.denominator}"
        
        # ... cÃ¡c type khÃ¡c tÆ°Æ¡ng tá»±
        
        options = _create_fraction_options(Fraction(correct_str))
        
        questions.append({
            "prefix": "HÃ£y thá»±c hiá»‡n phÃ¢n sá»‘ sau:",
            "question": question_content,
            "options": options,  # VD: ["3/4", "2/3", "5/8", "1/2"]
            "answer": correct_str,
            "answer_index": options.index(correct_str)  # QUAN TRá»ŒNG!
        })
    return questions
```

**Äiá»ƒm Ä‘áº·c biá»‡t**:
- TrÆ°á»ng `answer_index` giÃºp GameplayScreen biáº¿t KHÃ”NG SHUFFLE Ä‘Ã¡p Ã¡n
- ThÆ° viá»‡n `Fraction` tá»± Ä‘á»™ng rÃºt gá»n phÃ¢n sá»‘

---

### 2.3. Module Gameplay Screen (`src/screens/gameplay_screen.py`)

**Vai trÃ²**: MÃ n hÃ¬nh chÆ¡i chÃ­nh - 668 dÃ²ng code, phá»©c táº¡p nháº¥t trong dá»± Ã¡n

#### 2.3.1. Khá»Ÿi táº¡o mÃ n hÃ¬nh

```python
class GameplayScreen(BaseScreen):
    def __init__(self, game_manager):
        super().__init__(game_manager)
        
        # Khá»Ÿi táº¡o há»‡ thá»‘ng font vá»›i fallback
        try:
            if os.path.exists(VIETNAMESE_FONT_PATH):
                self.font_question = pygame.font.Font(VIETNAMESE_FONT_PATH, FONT_SIZE_LARGE)
                self.font_medium = pygame.font.Font(VIETNAMESE_FONT_PATH, FONT_SIZE_MEDIUM)
            else:
                # Fallback sang system font
                self.font_question = pygame.font.SysFont("Arial", FONT_SIZE_LARGE)
                self.font_medium = pygame.font.SysFont("Arial", FONT_SIZE_MEDIUM)
        except:
            self.font_question = pygame.font.SysFont("Arial", FONT_SIZE_LARGE)
        
        # Tráº¡ng thÃ¡i game
        self.score = 0
        self.best_score = 0
        self.time_left = TIME_LIMIT  # 30 giÃ¢y
        self.game_over = False
        self.is_new_best = False  # PhÃ¡ ká»· lá»¥c (nhÆ°ng khÃ´ng perfect)
        self.is_perfect = False   # Äiá»ƒm tuyá»‡t Ä‘á»‘i (200/200)
        
        self.assets = self._load_assets()
```

#### 2.3.2. Táº£i cÃ¢u há»i vá»›i logic trá»™n cÃ³ Ä‘iá»u kiá»‡n

```python
def load_next_question(self):
    if self.game_manager.question_index < len(self.game_manager.questions_pool):
        q_data = self.game_manager.questions_pool[self.game_manager.question_index]
        answers = [str(o) for o in q_data["options"]]
        correct_answer = str(q_data["answer"])
        
        # CHá»ˆ SHUFFLE Náº¾U KHÃ”NG CÃ“ answer_index
        # Level 5 (phÃ¢n sá»‘) cÃ³ answer_index â†’ giá»¯ nguyÃªn thá»© tá»±
        if "answer_index" not in q_data:
            random.shuffle(answers)
        
        self.current_question = {
            "prefix": q_data.get("prefix", "HÃ£y tráº£ lá»i cÃ¢u há»i sau:"),
            "question": q_data["question"],
            "answers": answers,
            "correct_answer": correct_answer,
            "question_number": self.game_manager.question_index + 1,
            "correct_index": answers.index(correct_answer)
        }
        
        # Reset timer
        self.start_time = time.time()
        self.time_left = self.time_limit
        self.game_manager.question_index += 1
    else:
        # Háº¿t cÃ¢u há»i
        self.game_over = True
        self.final_stars = self.calculate_stars(self.score)
        self.save_score(self.score)
```

**Giáº£i thÃ­ch**:
- `if "answer_index" not in q_data`: Kiá»ƒm tra cÃ³ pháº£i Level 5 khÃ´ng
- Level 5 khÃ´ng shuffle Ä‘á»ƒ giá»¯ nguyÃªn thá»© tá»± Ä‘Ã¡p Ã¡n phÃ¢n sá»‘

#### 2.3.3. Xá»­ lÃ½ Ä‘Ã¡p Ã¡n vá»›i pháº£n há»“i khÃ´ng bá»‹ cháº·n

```python
def process_answer(self, selected_index):
    # PhÃ¡t Ã¢m click
    if selected_index >= 0 and self.game_manager.sounds:
        if 'click' in self.game_manager.sounds and self.game_manager.menu.sound_setting:
            self.game_manager.sounds['click'].play()
            
    self.selected_answer_index = selected_index
    
    if selected_index >= 0:
        is_correct = (selected_index == self.current_question["correct_index"])
        if is_correct:
            self.score += POINTS_CORRECT  # +10
            self._play_sound('yes')
        else:
            self.score = max(0, self.score + POINTS_WRONG)  # -5, khÃ´ng Ã¢m
            self._play_sound('no')
    else:  # Háº¿t giá» (selected_index = -2)
        self.score = max(0, self.score + POINTS_WRONG)
        self._play_sound('no')
    
    # Äáº¶T THá»œI ÄIá»‚M Káº¾T THÃšC FEEDBACK (NON-BLOCKING!)
    self.show_feedback_until = time.time() + 1.5  # 1.5 giÃ¢y
```

**Äiá»ƒm quan trá»ng**:
- KHÃ”NG dÃ¹ng `pygame.time.delay()` vÃ¬ nÃ³ block toÃ n bá»™ game
- DÃ¹ng `show_feedback_until` vÃ  kiá»ƒm tra trong `update()`

#### 2.3.4. Update loop vá»›i bá»™ Ä‘iáº¿m thá»i gian thá»±c
```python
def update(self):
    # Náº¿u popup settings Ä‘ang má»Ÿ, chá»‰ update popup
    if hasattr(self.game_manager, 'menu') and self.game_manager.menu.show_settings:
        self.game_manager.menu.update()
        return
    
    if self.game_over: 
        return
    
    current_time = time.time()
    
    # Äáº¿m ngÆ°á»£c thá»i gian (REALTIME, khÃ´ng pháº£i frame-based)
    if self.selected_answer_index is None:
        time_spent = current_time - self.start_time
        self.time_left = max(0, int(self.time_limit - time_spent))
        
        # Háº¿t giá» â†’ tá»± Ä‘á»™ng tráº£ lá»i sai
        if self.time_left <= 0: 
            self.process_answer(-2)
    
    # Tá»± Ä‘á»™ng chuyá»ƒn cÃ¢u sau khi hiá»ƒn thá»‹ feedback Ä‘á»§ 1.5s
    if self.selected_answer_index is not None and current_time >= self.show_feedback_until:
        self.load_next_question()
```

**Giáº£i thÃ­ch**:
- `time.time()`: Thá»i gian thá»±c (giÃ¢y), khÃ´ng phá»¥ thuá»™c FPS
- Tá»± Ä‘á»™ng chuyá»ƒn cÃ¢u khi `current_time >= show_feedback_until`

#### 2.3.5. Parsing biá»ƒu thá»©c toÃ¡n há»c

```python
def parse_math_expression(self, expression):
    """
    PhÃ¢n tÃ­ch biá»ƒu thá»©c thÃ nh [(type, value), ...]
    VD: "6/8 + 3/7" â†’ [("fraction", "6/8"), ("operator", "+"), ("fraction", "3/7")]
    """
    components = []
    i = 0
    expression = expression.strip()
    
    while i < len(expression):
        # Bá» qua khoáº£ng tráº¯ng
        if expression[i].isspace():
            i += 1
            continue
        
        # Kiá»ƒm tra toÃ¡n tá»­ (há»— trá»£ cáº£ âˆ’ vÃ  Ã·)
        if expression[i] in ['+', '-', 'Ã—', ':', 'âˆ’', 'Ã·']:
            components.append(("operator", expression[i]))
            i += 1
            continue
        
        # TÃ¬m token sá»‘ hoáº·c phÃ¢n sá»‘
        start = i
        while i < len(expression) and expression[i] not in ['+', '-', 'Ã—', ':', 'âˆ’', 'Ã·']:
            i += 1
        
        token = expression[start:i].strip()
        
        if '/' in token:
            components.append(("fraction", token))
        elif token:
            components.append(("number", token))
    
    return components
```

**Äiá»ƒm ná»•i báº­t**:
- Duyá»‡t tá»«ng kÃ½ tá»±, khÃ´ng dÃ¹ng `split()`
- Há»— trá»£ toÃ¡n tá»­ Ä‘áº·c biá»‡t: `âˆ’` (minus sign Unicode), `Ã·` (division sign)

#### 2.3.6. Váº½ cÃ¢u há»i vá»›i logic Ä‘áº·c biá»‡t cho Level 4/6

```python
def draw(self, surface):
    if not self.game_over and self.current_question:
        q_text = self.current_question["question"]
        
        # LOGIC Äáº¶C BIá»†T CHO LEVEL TÃŒM X
        current_level = self.game_manager.current_level_key
        is_find_x_level = current_level in ["LEVEL_4", "LEVEL_6"]
        
        if is_find_x_level:
            # Hiá»ƒn thá»‹ toÃ n bá»™: "3x + 5 = 20" (khÃ´ng thÃªm "= ?")
            math_part = q_text
            eq_text = ""
        else:
            # Cáº¯t pháº§n sau "=" vÃ  thÃªm "= ?"
            # "45 + 67 = 112" â†’ váº½ "45 + 67" + "= ?"
            math_part = q_text.split("=")[0].strip() if "=" in q_text else q_text
            eq_text = "= ?" if "=" in q_text else ""
        
        # Render "= ?"
        eq_surf = self.font_question.render(eq_text, True, COLOR_BLACK)
        
        # Váº½ math_part báº±ng hÃ m draw_math_expression()
        self.draw_math_expression(surface, math_part, center_pos, self.font_question, COLOR_BLACK)
        
        # Váº½ "= ?" bÃªn cáº¡nh
        if eq_text:
            surface.blit(eq_surf, ...)
```

**Äiá»ƒm quan trá»ng**:
- Level 4vÃ  6 (tÃ¬m X): Hiá»ƒn thá»‹ nguyÃªn cÃ¢u há»i `"3x + 5 = 20"`
- CÃ¡c level khÃ¡c: Cáº¯t sau `=` vÃ  thÃªm `= ?`

#### 2.3.7. Tá»± Ä‘á»™ng giÃ£n kÃ­ch thÆ°á»›c theo ná»™i dung

```python
def draw(self, surface):
    # ... (tiáº¿p theo pháº§n trÃªn)
    
    # TÃ­nh toÃ¡n kÃ­ch thÆ°á»›c ná»™i dung báº±ng parser
    components = self.parse_math_expression(math_part)
    
    f_w = 0  # Total width
    f_h = 0  # Max height
    
    for comp_type, comp_value in components:
        if comp_type == "fraction":
            parts = comp_value.split("/")
            num_size = self.font_question.size(parts[0].strip())
            den_size = self.font_question.size(parts[1].strip())
            comp_w = max(num_size[0], den_size[0]) + 20
            comp_h = num_size[1] + den_size[1] + 20
        elif comp_type == "operator":
            comp_w, comp_h = self.font_question.size(f" {comp_value} ")
        else:  # number
            comp_w, comp_h = self.font_question.size(comp_value)
        
        f_w += comp_w
        f_h = max(f_h, comp_h)
    
    # ÄIá»€U CHá»ˆNH KHUNG CÃ‚U Há»I LINH HOáº T
    dynamic_q_width = max(950, f_w + eq_surf.get_width() + 120)
    dynamic_q_height = max(200, f_h + 100)
    
    # Scale áº£nh ná»n cÃ¢u há»i theo kÃ­ch thÆ°á»›c Ä‘á»™ng
    q_bg_img = pygame.transform.smoothscale(
        self.assets['nen_cauhoi'],
        (int(dynamic_q_width), int(dynamic_q_height))
    )
    q_bg_rect = q_bg_img.get_rect(center=self.question_pos)
    surface.blit(q_bg_img, q_bg_rect)
```

**TÆ°Æ¡ng tá»± cho Ä‘Ã¡p Ã¡n**:

```python
# ÄIá»€U CHá»ˆNH NÃšT ÄÃP ÃN
for i, opt_text in enumerate(self.current_question["answers"]):
    # TÃ­nh kÃ­ch thÆ°á»›c Ä‘Ã¡p Ã¡n
    if "/" in opt_text:
        opt_parts = opt_text.split("/")
        num_size = self.font_medium.size(opt_parts[0].strip())
        den_size = self.font_medium.size(opt_parts[1].strip())
        opt_w = max(num_size[0], den_size[0])
        opt_h = num_size[1] + den_size[1]
    else:
        opt_w, opt_h = self.font_medium.size(opt_text)
    
    # Dynamic sizing (min 350x80)
    dynamic_ans_width = max(350, opt_w + 100)
    dynamic_ans_height = max(80, opt_h + 20)
    
    rect = pygame.Rect(0, 0, int(dynamic_ans_width), int(dynamic_ans_height))
    # ... vá»‹ trÃ­ vÃ  váº½
    
    ans_img = pygame.transform.smoothscale(
        self.assets['nen_dapan'],
        (rect.width, rect.height)
    )
    surface.blit(ans_img, rect.topleft)
```

**Ã nghÄ©a**:
- Khung cÃ¢u há»i vÃ  nÃºt Ä‘Ã¡p Ã¡n Tá»° Äá»˜NG GIÃƒN kÃ­ch thÆ°á»›c
- PhÃ¢n sá»‘ cao â†’ khung cao hÆ¡n
- Biá»ƒu thá»©c dÃ i â†’ khung rá»™ng hÆ¡n

#### 2.3.8. Thanh tiáº¿n Ä‘á»™ vá»›i cá»™t má»‘c sao

```python
def draw(self, surface):
    # ... váº½ thanh tiáº¿n Ä‘á»™
    
    progress_bar_bg = self.assets['thanh_sao_0']
    bar_pos_rect = progress_bar_bg.get_rect(center=(SCREEN_WIDTH // 2, ...))
    surface.blit(progress_bar_bg, bar_pos_rect.topleft)
    
    # TÃ­nh tá»· lá»‡ Ä‘iá»ƒm
    max_level_score = len(self.game_manager.questions_pool) * POINTS_CORRECT
    score_ratio = min(1.0, self.score / max_level_score) if max_level_score > 0 else 0
    
    # Váº½ pháº§n fill mÃ u vÃ ng
    INNER_PADDING_X, INNER_PADDING_Y = 15, 10
    fill_max_w = bar_pos_rect.width - (2 * INNER_PADDING_X)
    current_fill_w = int(fill_max_w * score_ratio)
    
    if current_fill_w > 0:
        fill_color = (255, 215, 0)  # VÃ ng
        fill_height = bar_pos_rect.height - (2 * INNER_PADDING_Y)
        radius = fill_height // 2
        start_x = bar_pos_rect.x + INNER_PADDING_X
        start_y = bar_pos_rect.y + INNER_PADDING_Y
        
        # Váº½ vá»›i border radius
        pygame.draw.circle(surface, fill_color, (start_x + radius, start_y + radius), radius)
        if current_fill_w > radius:
            pygame.draw.rect(surface, fill_color, 
                           pygame.Rect(start_x, start_y, current_fill_w, fill_height),
                           border_radius=radius)
    
    # Váº¼ 3 SAO MILESTONE Táº I 50%, 75%, 95%
    star_icon_small = pygame.transform.scale(self.assets['sao_large'], (30, 30))
    star_milestones = [0.50, 0.75, 0.95]
    
    for milestone in star_milestones:
        star_x = bar_pos_rect.x + INNER_PADDING_X + int(fill_max_w * milestone)
        star_rect = star_icon_small.get_rect(center=(star_x, bar_pos_rect.centery))
        
        if score_ratio >= milestone:
            # Sao sÃ¡ng
            surface.blit(star_icon_small, star_rect)
        else:
            # Sao tá»‘i (chÆ°a Ä‘áº¡t)
            dark_star = star_icon_small.copy()
            dark_star.fill((100, 100, 100), special_flags=pygame.BLEND_RGB_MULT)
            surface.blit(dark_star, star_rect)
```

**Äiá»ƒm ná»•i báº­t**:
- 3 milestone: 50% (1 sao), 75% (2 sao), 95% (3 sao)
- Sao tá»‘i Ä‘en khi chÆ°a Ä‘áº¡t má»‘c

#### 2.3.9. LÆ°u Ä‘iá»ƒm vá»›i is_perfect vÃ  is_new_best

```python
def save_score(self, new_score):
    if not self.game_manager.current_level_key: 
        return
    
    max_possible_score = len(self.game_manager.questions_pool) * POINTS_CORRECT
    scores_data = self.game_manager.game_data.get('scores', {})
    level_key = self.game_manager.current_level_key
    level_data = scores_data.get(level_key, {'high_score': 0})
    
    # LOGIC PHÃ‚N BIá»†T PERFECT VÃ€ NEW BEST
    if new_score >= max_possible_score and max_possible_score > 0:
        # Äiá»ƒm tuyá»‡t Ä‘á»‘i (200/200)
        self.is_perfect = True
        self.is_new_best = False
    elif new_score > level_data['high_score']:
        # PhÃ¡ ká»· lá»¥c (nhÆ°ng khÃ´ng perfect)
        self.is_new_best = True
        self.is_perfect = False
        
    # LÆ°u Ä‘iá»ƒm cao
    if new_score > level_data['high_score']:
        level_data['high_score'] = new_score
        scores_data[level_key] = level_data
        self.game_manager.game_data['scores'] = scores_data
    
    # LÆ°u sao
    new_stars = self.calculate_stars(new_score)
    current_stars = self.game_manager.game_data.get('stars', [0] * len(LEVELS))
    try:
        idx = next(i for i, lv in enumerate(LEVELS) if lv['key'] == level_key)
        if new_stars > current_stars[idx]:
            current_stars[idx] = new_stars
            self.game_manager.game_data['stars'] = current_stars
    except: 
        pass
    
    save_game_data(self.game_manager.game_data)
```

**Giáº£i thÃ­ch**:
- `is_perfect`: Äáº¡t 200/200 Ä‘iá»ƒm â†’ hiá»‡n áº£nh `perfect_score.png`
- `is_new_best`: PhÃ¡ ká»· lá»¥c cÅ© (nhÆ°ng khÃ´ng perfect) â†’ hiá»‡n áº£nh `new_best_score.png`

#### 2.3.10. MÃ n hÃ¬nh káº¿t quáº£

```python
def draw(self, surface):
    if self.game_over:
        # Overlay tá»‘i
        overlay = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.SRCALPHA)
        overlay.fill((0, 0, 0, 200))
        surface.blit(overlay, (0, 0))
        
        # Váº½ áº£nh game over
        go_rect = self.assets['game_over_image'].get_rect(center=(SCREEN_WIDTH//2, SCREEN_HEIGHT//2))
        surface.blit(self.assets['game_over_image'], go_rect)
        
        # CHá»ŒN HÃŒNH áº¢NH Káº¾T QUáº¢
        res_img = None
        if self.is_perfect: 
            res_img = self.assets['img_perfect']
        elif self.is_new_best: 
            res_img = self.assets['img_new_best']
        
        if res_img:
            res_rect = res_img.get_rect(center=(SCREEN_WIDTH//2, go_rect.centery))
            surface.blit(res_img, res_rect)
        
        # Äiá»ƒm hiá»‡n táº¡i (mÃ u Ä‘á»)
        score_txt = self.font_title.render(f"{self.score}", True, (255, 0, 0))
        surface.blit(score_txt, score_txt.get_rect(center=(SCREEN_WIDTH//2, go_rect.centery)))
        
        # Best score (mÃ u xÃ¡m)
        best_score_txt = self.font_title.render(f"{self.best_score}", True, (55, 55, 55))
        surface.blit(best_score_txt, best_score_txt.get_rect(center=(SCREEN_WIDTH//2, go_rect.centery + 130)))
        
        # Váº¼ 3 SAO
        if not self.is_perfect or not self.is_new_best:
            star_base_x = SCREEN_WIDTH // 2 - 90
            for i in range(1, 4):
                single_star = self.assets['sao_result'].copy()
                
                # LÃ m tá»‘i sao chÆ°a Ä‘áº¡t
                if i > self.final_stars:
                    gray_filter = pygame.Surface(single_star.get_size(), pygame.SRCALPHA)
                    gray_filter.fill((40, 40, 40, 190))
                    single_star.blit(gray_filter, (0, 0), special_flags=pygame.BLEND_RGBA_MULT)
                
                surface.blit(single_star, (star_base_x + (i-1)*90 - 40, go_rect.centery - 170))
        
        # NÃºt Next vÃ  Replay
        surface.blit(self.assets['nut_next'], self.next_button_rect.topleft)
        surface.blit(self.assets['nut_relay'], self.replay_button_rect.topleft)
```

---

### 2.4. Module Level Select Screen (`src/screens/level_select_screen.py`)

**Vai trÃ²**: MÃ n hÃ¬nh chá»n level - 263 dÃ²ng code, quáº£n lÃ½ viá»‡c hiá»ƒn thá»‹ 6 level vá»›i logic khÃ³a

#### 2.4.1. Khá»Ÿi táº¡o mÃ n hÃ¬nh

```python
class LevelSelectScreen(BaseScreen):
    def __init__(self, game_manager):
        super().__init__(game_manager)
        
        # Khá»Ÿi táº¡o font vá»›i fallback
        try:
            if VIETNAMESE_FONT_PATH and os.path.exists(VIETNAMESE_FONT_PATH):
                self.font_title = pygame.font.Font(VIETNAMESE_FONT_PATH, FONT_SIZE_TITLE)
                self.font_small = pygame.font.Font(VIETNAMESE_FONT_PATH, FONT_SIZE_SMALL)
            else:
                self.font_title = pygame.font.SysFont("Arial", FONT_SIZE_TITLE)
                self.font_small = pygame.font.SysFont("Arial", FONT_SIZE_SMALL)
        except pygame.error:
            # Fallback cuá»‘i cÃ¹ng
            self.font_title = pygame.font.SysFont("Arial", FONT_SIZE_TITLE)
            self.font_small = pygame.font.SysFont("Arial", FONT_SIZE_SMALL)
        
        # Danh sÃ¡ch rect cá»§a cÃ¡c nÃºt level (Ä‘Æ°á»£c tÃ­nh láº¡i má»—i frame)
        self.level_rects = []
        
        # NÃºt cÃ i Ä‘áº·t
        self.setting_button_rect = pygame.Rect(0, 0, 1, 1)
        
        # Táº£i assets
        self.assets = self._load_assets()
```

**Giáº£i thÃ­ch**:
- `level_rects`: Máº£ng chá»©a vá»‹ trÃ­ vÃ  index cá»§a 6 nÃºt level, Ä‘Æ°á»£c reset má»—i frame trong `draw()`
- Font system tÆ°Æ¡ng tá»± GameplayScreen vá»›i fallback mechanism

#### 2.4.2. Váº½ layout 6 level (2 hÃ ng Ã— 3 cá»™t)

```python
def draw(self, surface):
    self.level_rects = []  # Reset má»—i frame
    
    # Váº½ ná»n
    surface.blit(self.assets['nen_lv'], (0, 0))
    
    # Láº¥y dá»¯ liá»‡u sao
    stars_data = self.game_manager.game_data.get('stars', [0] * len(LEVELS))
    
    # ThÃ´ng sá»‘ layout
    level_button_width = 200
    level_button_height = 55
    padding_x = 80  # Khoáº£ng cÃ¡ch ngang giá»¯a cÃ¡c nÃºt
    padding_y = 80  # Khoáº£ng cÃ¡ch dá»c giá»¯a cÃ¡c hÃ ng
    
    # TÃ­nh toÃ¡n vá»‹ trÃ­ báº¯t Ä‘áº§u Ä‘á»ƒ cÄƒn giá»¯a mÃ n hÃ¬nh
    # 3 cá»™t Ã— 200px + 2 khoáº£ng cÃ¡ch Ã— 80px
    total_width_row = (level_button_width * 3) + (padding_x * 2)
    start_x = (SCREEN_WIDTH - total_width_row) // 2
    start_y = 250  # Vá»‹ trÃ­ Y cá»‘ Ä‘á»‹nh
    
    for i, level in enumerate(LEVELS):
        # TÃ­nh vá»‹ trÃ­ hÃ ng vÃ  cá»™t
        row = i // 3  # 0, 0, 0, 1, 1, 1
        col = i % 3   # 0, 1, 2, 0, 1, 2
        
        x_pos = start_x + col * (level_button_width + padding_x)
        y_pos = start_y + row * (level_button_height + padding_y)
        
        button_rect = pygame.Rect(x_pos, y_pos, level_button_width, level_button_height)
        
        # LÆ°u rect Ä‘á»ƒ xá»­ lÃ½ click sau
        self.level_rects.append({'index': i, 'rect': button_rect})
        
        # ... váº½ level (tiáº¿p theo)
```

**Giáº£i thÃ­ch**:
- Layout grid 2Ã—3: `row = i // 3`, `col = i % 3`
- CÄƒn giá»¯a toÃ n bá»™ grid báº±ng cÃ¡ch tÃ­nh `total_width_row`
- `level_rects` Ä‘Æ°á»£c cáº­p nháº­t má»—i frame Ä‘á»ƒ Ä‘áº£m báº£o collision detection chÃ­nh xÃ¡c

#### 2.4.3. Logic khÃ³a level

```python
# ... (tiáº¿p theo trong vÃ²ng for)

# Level 1 (index 0) luÃ´n má»Ÿ
# Level 2-6 chá»‰ má»Ÿ khi level trÆ°á»›c cÃ³ >= 1 sao
is_locked = (i > 0 and stars_data[i-1] == 0)

# Váº½ icon level bÃ¬nh thÆ°á»ng
level_image = self.assets.get(level['image_key'])  # VD: 'lv1', 'lv2'
if level_image:
    surface.blit(level_image, button_rect.topleft)

# Váº½ sá»‘ sao Ä‘Ã£ Ä‘áº¡t (náº¿u cÃ³)
current_stars_level = stars_data[i]
if current_stars_level > 0:
    star_asset = self.assets.get('star_icon')
    if star_asset:
        star_size = star_asset.get_width()  # 20px
        
        # TÃ­nh tá»•ng chiá»u rá»™ng Ä‘á»ƒ cÄƒn giá»¯a khá»‘i sao
        star_spacing = 4  # Khoáº£ng cÃ¡ch giá»¯a cÃ¡c sao
        total_stars_width = (current_stars_level * star_size) + \
                           ((current_stars_level - 1) * star_spacing)
        
        # Vá»‹ trÃ­ X báº¯t Ä‘áº§u (cÄƒn giá»¯a)
        start_star_x = button_rect.centerx - (total_stars_width // 2)
        star_y = button_rect.bottom - star_size + 20  # Gáº§n Ä‘Ã¡y nÃºt
        
        # Váº½ tá»«ng sao
        for star_index in range(current_stars_level):
            star_x = start_star_x + star_index * (star_size + star_spacing)
            surface.blit(star_asset, (star_x, star_y))

# Váº½ icon khÃ³a náº¿u level bá»‹ khÃ³a
if is_locked:
    khoa_asset = self.assets['khoalv']
    # CÄƒn giá»¯a icon khÃ³a trong nÃºt
    khoa_rect = khoa_asset.get_rect(center=button_rect.center)
    surface.blit(khoa_asset, khoa_rect.topleft)
```

**Giáº£i thÃ­ch**:
- `is_locked`: Kiá»ƒm tra `i > 0` (khÃ´ng pháº£i level 1) VÃ€ `stars_data[i-1] == 0` (level trÆ°á»›c chÆ°a cÃ³ sao)
- Sao Ä‘Æ°á»£c cÄƒn giá»¯a báº±ng cÃ¡ch tÃ­nh `total_stars_width`
- Icon khÃ³a Ä‘Æ°á»£c váº½ Ä‘Ã¨ lÃªn level bá»‹ khÃ³a

#### 2.4.4. Xá»­ lÃ½ click vá»›i há»‡ thá»‘ng Æ°u tiÃªn

```python
def handle_input(self, event):
    if event.type == pygame.MOUSEBUTTONDOWN:
        mouse_pos = event.pos
        
        # Æ¯U TIÃŠN 1: Náº¿u popup settings Ä‘ang má»Ÿ, chá»‰ xá»­ lÃ½ popup
        if self.game_manager.menu.show_settings:
            self.game_manager.menu.handle_input(event)
            return  # KhÃ´ng xá»­ lÃ½ gÃ¬ khÃ¡c
        
        # Æ¯U TIÃŠN 2: Click nÃºt cÃ i Ä‘áº·t â†’ má»Ÿ popup
        if self.setting_button_rect.collidepoint(mouse_pos):
            self.game_manager.menu.show_settings = True
            return
        
        # Æ¯U TIÃŠN 3: Click vÃ o level
        for rect_data in self.level_rects:
            i = rect_data['index']
            rect = rect_data['rect']
            
            if rect.collidepoint(mouse_pos):
                # PhÃ¡t Ã¢m thanh click
                self.game_manager.sounds['click'].play()
                
                # Láº¥y dá»¯ liá»‡u sao Ä‘á»ƒ kiá»ƒm tra khÃ³a
                stars_data = self.game_manager.game_data.get('stars', [0] * len(LEVELS))
                is_locked = (i > 0 and stars_data[i-1] == 0)
                
                if not is_locked:
                    # Level má»Ÿ â†’ chuyá»ƒn sang gameplay
                    selected_level = LEVELS[i]
                    self.game_manager.current_level_key = selected_level['key']
                    print(f"Báº¡n Ä‘Ã£ chá»n: {self.game_manager.current_level_key}")
                    self.game_manager.switch_screen("GAMEPLAY")
                    return
                else:
                    # Level khÃ³a â†’ in thÃ´ng bÃ¡o (hoáº·c phÃ¡t Ã¢m lá»—i)
                    print("Level Ä‘ang bá»‹ khÃ³a!")
                    return
```

**Giáº£i thÃ­ch chi tiáº¿t**:
1. **Priority 1 - Popup**: Náº¿u popup settings Ä‘ang má»Ÿ, chá»‰ xá»­ lÃ½ event cho popup, ignore cÃ¡c click khÃ¡c
2. **Priority 2 - Settings button**: Click nÃºt cÃ i Ä‘áº·t â†’ set `show_settings = True`
3. **Priority 3 - Level selection**: Click level â†’ kiá»ƒm tra khÃ³a â†’ chuyá»ƒn mÃ n hÃ¬nh
4. **Táº¡i sao dÃ¹ng priority system?** TrÃ¡nh click xuyÃªn qua popup (click nháº§m level khi popup Ä‘ang má»Ÿ)

---

### 2.5. Module Menu Screen (`src/screens/menu_screen.py`)

**Vai trÃ²**: POPUP cÃ i Ä‘áº·t overlay - 157 dÃ²ng code, khÃ´ng pháº£i mÃ n hÃ¬nh Ä‘á»™c láº­p

#### 2.5.1. Khá»Ÿi táº¡o popup

```python
class MenuScreen(BaseScreen):
    def __init__(self, game_manager):
        super().__init__(game_manager)
        
        # Tráº¡ng thÃ¡i popup
        self.show_settings = False  # False = áº©n, True = hiá»‡n
        self.sound_setting = True   # True = báº­t Ã¢m thanh
        self.bgm_setting = True     # True = báº­t nháº¡c ná»n
        
        # Táº£i assets (áº£nh ná»n popup, toggle on/off, nÃºt)
        self.assets = self._load_assets()
        
        # Khá»Ÿi táº¡o font
        try:
            if VIETNAMESE_FONT_PATH and os.path.exists(VIETNAMESE_FONT_PATH):
                self.font_small = pygame.font.Font(VIETNAMESE_FONT_PATH, FONT_SIZE_SMALL)
            else:
                self.font_small = pygame.font.SysFont("Arial", FONT_SIZE_SMALL)
        except pygame.error:
            self.font_small = pygame.font.SysFont("Arial", FONT_SIZE_SMALL)
        
        # Vá»‹ trÃ­ cÃ¡c thÃ nh pháº§n trong popup (400Ã—450px)
        self.settings_rect = self.assets['nen_caidat'].get_rect(
            center=(SCREEN_WIDTH // 2, SCREEN_HEIGHT // 2)
        )
        
        # NÃºt Ä‘Ã³ng (X) á»Ÿ gÃ³c trÃªn pháº£i
        self.close_rect = pygame.Rect(
            self.settings_rect.right - 40,
            self.settings_rect.y + 10,
            30, 30
        )
        
        # 4 dÃ²ng chá»©c nÄƒng
        self.sound_rect = pygame.Rect(
            self.settings_rect.x + 50,
            self.settings_rect.y + 120,
            300, 50
        )
        self.bgm_rect = pygame.Rect(
            self.settings_rect.x + 50,
            self.settings_rect.y + 190,
            300, 50
        )
        self.home_rect = pygame.Rect(
            self.settings_rect.x + 50,
            self.settings_rect.y + 280,
            300, 50
        )
        self.replay_rect = pygame.Rect(
            self.settings_rect.x + 50,
            self.settings_rect.y + 360,
            300, 50
        )
```

**Giáº£i thÃ­ch**:
- `show_settings`: Biáº¿n boolean Ä‘iá»u khiá»ƒn hiá»ƒn thá»‹ popup, Ä‘Æ°á»£c set bá»Ÿi nÃºt cÃ i Ä‘áº·t
- Popup cÄƒn giá»¯a mÃ n hÃ¬nh: `center=(SCREEN_WIDTH // 2, SCREEN_HEIGHT // 2)`
- 4 rect chá»©c nÄƒng: Sound on/off, BGM on/off, Home, Replay

#### 2.5.2. Váº½ popup vá»›i lá»›p phá»§ tá»‘i

```python
def draw(self, surface):
    """Váº½ popup lÃªn trÃªn mÃ n hÃ¬nh hiá»‡n táº¡i (khÃ´ng thay tháº¿ mÃ n hÃ¬nh)"""
    
    # BÆ¯á»šC 1: Váº½ overlay tá»‘i phÃ­a sau
    # pygame.SRCALPHA = há»— trá»£ trong suá»‘t
    overlay = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT), pygame.SRCALPHA)
    overlay.fill((0, 0, 0, 150))  # MÃ u Ä‘en, alpha = 150/255 â‰ˆ 59% trong suá»‘t
    surface.blit(overlay, (0, 0))
    
    # BÆ¯á»šC 2: Váº½ khung popup (400Ã—450px)
    surface.blit(self.assets['nen_caidat'], self.settings_rect.topleft)
    
    # BÆ¯á»šC 3: Váº½ toggle on/off cho Sound
    # Chá»n icon dá»±a trÃªn tráº¡ng thÃ¡i
    sound_icon = self.assets['on'] if self.sound_setting else self.assets['off']
    sound_icon_rect = sound_icon.get_rect(
        midright=(self.settings_rect.right - 40, self.sound_rect.centery)
    )
    surface.blit(sound_icon, sound_icon_rect.topleft)
    
    # BÆ¯á»šC 4: Váº½ toggle on/off cho BGM
    bgm_icon = self.assets['on'] if self.bgm_setting else self.assets['off']
    bgm_icon_rect = bgm_icon.get_rect(
        midright=(self.settings_rect.right - 40, self.bgm_rect.centery)
    )
    surface.blit(bgm_icon, bgm_icon_rect.topleft)
    
    # BÆ¯á»šC 5: Váº½ icon nÃºt Home (back arrow)
    if 'nut_back_icon' in self.assets:
        icon_asset = self.assets['nut_back_icon']
        icon_rect = icon_asset.get_rect(
            midright=(self.home_rect.right - 0, self.home_rect.centery)
        )
        surface.blit(icon_asset, icon_rect.topleft)
    
    # BÆ¯á»šC 6: Váº½ icon nÃºt Replay (play icon)
    if 'nut_play_icon' in self.assets:
        icon_asset = self.assets['nut_play_icon']
        icon_rect = icon_asset.get_rect(
            midright=(self.replay_rect.right - 0, self.replay_rect.centery)
        )
        surface.blit(icon_asset, icon_rect.topleft)
    
    # BÆ¯á»šC 7: Váº½ nÃºt Ä‘Ã³ng (X) báº±ng hÃ¬nh trÃ²n + text
    pygame.draw.circle(surface, COLOR_WRONG, self.close_rect.center, 15)
    close_text = self.font_small.render("X", True, COLOR_WHITE)
    close_text_rect = close_text.get_rect(center=self.close_rect.center)
    surface.blit(close_text, close_text_rect)
```

**Giáº£i thÃ­ch chi tiáº¿t**:
- **Overlay**: `fill((0, 0, 0, 150))` táº¡o lá»›p Ä‘en trong suá»‘t che má» mÃ n hÃ¬nh phÃ­a sau
- **Conditional rendering**: `self.assets['on'] if self.sound_setting else self.assets['off']`
- **midright alignment**: Icon toggle cÄƒn lá» pháº£i trong popup
- **Circle + Text**: NÃºt X Ä‘Æ°á»£c váº½ báº±ng `draw.circle()` + render text

#### 2.5.3. Xá»­ lÃ½ click trong popup

```python
def handle_input(self, event):
    if event.type == pygame.MOUSEBUTTONDOWN:
        mouse_pos = event.pos
        
        # Click nÃºt X â†’ Ä‘Ã³ng popup
        if self.close_rect.collidepoint(mouse_pos):
            self.show_settings = False
            return
        
        # Click toggle Sound
        if self.sound_rect.collidepoint(mouse_pos):
            self.sound_setting = not self.sound_setting  # Äá»•i True â†” False
            # Logic Ä‘iá»u khiá»ƒn sáº½ Ä‘Æ°á»£c xá»­ lÃ½ trong update()
            return
        
        # Click toggle BGM
        elif self.bgm_rect.collidepoint(mouse_pos):
            self.bgm_setting = not self.bgm_setting
            return
        
        # Click Home â†’ vá» mÃ n hÃ¬nh chÃ­nh + Ä‘Ã³ng popup
        elif self.home_rect.collidepoint(mouse_pos):
            self.game_manager.switch_screen("HOME")
            self.show_settings = False
            
            # Náº¿u Ä‘ang trong gameplay, reset game
            if self.game_manager.active_screen_key == "GAMEPLAY":
                self.game_manager.screens[self.game_manager.active_screen_key].reset_game()
            return
        
        # Click Replay â†’ chÆ¡i láº¡i tá»« Ä‘áº§u
        elif self.replay_rect.collidepoint(mouse_pos):
            self.show_settings = False
            
            if self.game_manager.active_screen_key == "GAMEPLAY":
                # Reset index cÃ¢u há»i vá» 0
                self.game_manager.question_index = 0
                # Reset game state
                self.game_manager.screens[self.game_manager.active_screen_key].reset_game()
                # Load cÃ¢u há»i Ä‘áº§u tiÃªn
                self.game_manager.screens[self.game_manager.active_screen_key].load_next_question()
            else:
                # Náº¿u khÃ´ng pháº£i gameplay, vá» Home
                self.game_manager.switch_screen("HOME")
            return
```

**Giáº£i thÃ­ch**:
- **Toggle logic**: `not self.sound_setting` Ä‘áº£o ngÆ°á»£c True thÃ nh False vÃ  ngÆ°á»£c láº¡i
- **Home button**: Reset game náº¿u Ä‘ang trong gameplay Ä‘á»ƒ trÃ¡nh lá»—i state
- **Replay button**: KhÃ¡c nhau tÃ¹y mÃ n hÃ¬nh - gameplay thÃ¬ replay, mÃ n khÃ¡c thÃ¬ vá» Home

#### 2.5.4. Update Ä‘iá»u khiá»ƒn Ã¢m thanh thá»i gian thá»±c

```python
def update(self):
    """ÄÆ°á»£c gá»i má»—i frame Ä‘á»ƒ cáº­p nháº­t tráº¡ng thÃ¡i Ã¢m thanh"""
    
    # Äiá»u khiá»ƒn nháº¡c ná»n (Background Music)
    if self.bgm_setting:
        pygame.mixer.music.unpause()  # Tiáº¿p tá»¥c phÃ¡t
    else:
        pygame.mixer.music.pause()    # Táº¡m dá»«ng (khÃ´ng stop, giá»¯ vá»‹ trÃ­)
    
    # Äiá»u khiá»ƒn Ã¢m thanh hiá»‡u á»©ng (Sound Effects)
    if self.sound_setting:
        # Báº­t Ã¢m thanh â†’ volume = 1.0 (100%)
        self.game_manager.sounds['click'].set_volume(1.0)
        # CÃ¡c sound khÃ¡c cÅ©ng tÆ°Æ¡ng tá»±
    else:
        # Táº¯t Ã¢m thanh â†’ volume = 0.0 (0%, mute)
        self.game_manager.sounds['click'].set_volume(0.0)
```

**Giáº£i thÃ­ch**:
- **pause() vs stop()**: `pause()` giá»¯ vá»‹ trÃ­, `stop()` vá» Ä‘áº§u track
- **set_volume()**: Äiá»u chá»‰nh Ã¢m lÆ°á»£ng tá»« 0.0 (mute) Ä‘áº¿n 1.0 (max)
- **Realtime**: ÄÆ°á»£c gá»i má»—i frame, thay Ä‘á»•i setting ngay láº­p tá»©c cÃ³ hiá»‡u lá»±c

---

### 2.6. Module Save Manager (`data/save_manager.py`)

**Vai trÃ²**: LÆ°u vÃ  táº£i dá»¯ liá»‡u JSON - 35 dÃ²ng code, xá»­ lÃ½ persistence

#### 2.6.1. ÄÆ°á»ng dáº«n file save

```python
import json
import os

# TÃªn file lÆ°u trá»¯ náº±m cÃ¹ng thÆ° má»¥c data/
SAVE_FILE = os.path.join(os.path.dirname(__file__), "save.json")
```

**Giáº£i thÃ­ch**:
- `__file__`: ÄÆ°á»ng dáº«n tuyá»‡t Ä‘á»‘i Ä‘áº¿n file `save_manager.py`
- `os.path.dirname(__file__)`: Láº¥y thÆ° má»¥c chá»©a file (thÆ° má»¥c `data/`)
- `os.path.join()`: Ná»‘i Ä‘Æ°á»ng dáº«n cross-platform (Windows/Linux/Mac)
- Káº¿t quáº£: `d:\...\Du-an-phan-mem-hoc-tap-Smart-Math\data\save.json`

#### 2.6.2. Load dá»¯ liá»‡u vá»›i error handling

```python
def load_game_data():
    """Táº£i dá»¯ liá»‡u Ä‘iá»ƒm cao vÃ  sao Ä‘Ã£ lÆ°u. Náº¿u khÃ´ng cÃ³ file, tráº£ vá» máº·c Ä‘á»‹nh."""
    
    # Dá»¯ liá»‡u máº·c Ä‘á»‹nh cho láº§n Ä‘áº§u cháº¡y game
    default_data = {
        "highscores": [0] * 6,  # [0, 0, 0, 0, 0, 0] - deprecated
        "stars": [0] * 6,       # [0, 0, 0, 0, 0, 0]
        "scores": {}            # {} - format má»›i
    }
    
    # TRÆ¯á»œNG Há»¢P 1: File chÆ°a tá»“n táº¡i (láº§n Ä‘áº§u cháº¡y)
    if not os.path.exists(SAVE_FILE):
        return default_data
    
    # TRÆ¯á»œNG Há»¢P 2: File tá»“n táº¡i, cá»‘ gáº¯ng Ä‘á»c
    try:
        with open(SAVE_FILE, 'r') as f:
            data = json.load(f)  # Parse JSON thÃ nh Python dict
        
        # Äáº£m báº£o backward compatibility (file cÅ© cÃ³ thá»ƒ thiáº¿u data)
        # Náº¿u máº£ng highscores < 6 pháº§n tá»­, thÃªm cÃ¡c sá»‘ 0 vÃ o cuá»‘i
        if len(data.get('highscores', [])) < 6:
            current = data.get('highscores', [])
            missing = 6 - len(current)
            data['highscores'] = current + [0] * missing
        
        # TÆ°Æ¡ng tá»± cho stars
        if len(data.get('stars', [])) < 6:
            current = data.get('stars', [])
            missing = 6 - len(current)
            data['stars'] = current + [0] * missing
        
        return data
    
    # TRÆ¯á»œNG Há»¢P 3: File bá»‹ lá»—i (corrupt, format sai, ...)
    except Exception as e:
        print(f"Lá»—i khi Ä‘á»c file save.json: {e}. Tráº£ vá» dá»¯ liá»‡u máº·c Ä‘á»‹nh.")
        return default_data
```

**Giáº£i thÃ­ch chi tiáº¿t**:
1. **default_data**: Dá»¯ liá»‡u máº·c Ä‘á»‹nh khi file khÃ´ng tá»“n táº¡i hoáº·c lá»—i
2. **`[0] * 6`**: Táº¡o list 6 pháº§n tá»­ giÃ¡ trá»‹ 0: `[0, 0, 0, 0, 0, 0]`
3. **Backward compatibility**: Náº¿u file cÅ© chá»‰ cÃ³ 3 level, thÃªm 3 sá»‘ 0 cho level 4-6
4. **Exception handling**: Báº¯t má»i lá»—i (JSONDecodeError, IOError, ...) vÃ  tráº£ default
5. **Táº¡i sao cáº§n check < 6?** Khi thÃªm level má»›i, file save cÅ© khÃ´ng cÃ³ dá»¯ liá»‡u

#### 2.6.3. Save dá»¯ liá»‡u vá»›i pretty print

```python
def save_game_data(data):
    """LÆ°u dá»¯ liá»‡u Ä‘iá»ƒm cao vÃ  sao."""
    try:
        with open(SAVE_FILE, 'w') as f:
            # indent=4: Format JSON dá»… Ä‘á»c vá»›i thá»¥t lá» 4 spaces
            json.dump(data, f, indent=4)
    except Exception as e:
        print(f"Lá»—i khi ghi file save.json: {e}")
        # KhÃ´ng raise exception Ä‘á»ƒ game khÃ´ng crash
```

**Giáº£i thÃ­ch**:
- **`json.dump(data, f, indent=4)`**: Ghi dict Python thÃ nh JSON file vá»›i format Ä‘áº¹p
- **indent=4**: Má»—i cáº¥p thá»¥t 4 spaces, dá»… Ä‘á»c khi má»Ÿ file save.json
- **Exception khÃ´ng raise**: Náº¿u save tháº¥t báº¡i, chá»‰ in lá»—i, khÃ´ng crash game
- **Mode 'w'**: Ghi Ä‘Ã¨ toÃ n bá»™ file (khÃ´ng append)

#### 2.6.4. Cáº¥u trÃºc file `save.json`

```json
{
    "stars": [3, 2, 1, 0, 0, 0],
    "scores": {
        "LEVEL_1": {"high_score": 190},
        "LEVEL_2": {"high_score": 180},
        "LEVEL_3": {"high_score": 120}
    },
    "highscores": [190, 180, 120, 0, 0, 0]
}
```

**Giáº£i thÃ­ch cáº¥u trÃºc**:

| Field | Type | MÃ´ táº£ | VÃ­ dá»¥ |
|-------|------|-------|-------|
| `stars` | Array[int] | Sá»‘ sao (0-3) cá»§a 6 level | `[3, 2, 1, 0, 0, 0]` |
| `scores` | Dict | Äiá»ƒm cao cá»§a tá»«ng level (format má»›i) | `{"LEVEL_1": {"high_score": 190}}` |
| `highscores` | Array[int] | Äiá»ƒm cao (format cÅ©, deprecated) | `[190, 180, 120, 0, 0, 0]` |

**Táº¡i sao cÃ³ 2 format (scores vs highscores)?**
- `highscores`: Format cÅ©, máº£ng Ä‘Æ¡n giáº£n, dá»… truy cáº­p báº±ng index
- `scores`: Format má»›i, dictionary, dá»… má»Ÿ rá»™ng (cÃ³ thá»ƒ thÃªm best_time, attempts, ...)
- Giá»¯ cáº£ 2 Ä‘á»ƒ backward compatibility vá»›i code cÅ©

**VÃ­ dá»¥ truy cáº­p dá»¯ liá»‡u**:
```python
# CÃ¡ch cÅ© (dÃ¹ng index)
data = load_game_data()
level_1_high_score = data['highscores'][0]  # 190

# CÃ¡ch má»›i (dÃ¹ng key)
level_1_data = data['scores'].get('LEVEL_1', {'high_score': 0})
level_1_high_score = level_1_data['high_score']  # 190
```

---
### 2.7. Module Home Screen (`src/screens/home_screen.py`)

**Vai trÃ²**: MÃ n hÃ¬nh chÃ o má»«ng - 54 dÃ²ng code, Ä‘iá»ƒm khá»Ÿi Ä‘áº§u cá»§a game

#### 2.7.1. Khá»Ÿi táº¡o mÃ n hÃ¬nh

```python
class HomeScreen(BaseScreen):
    def __init__(self, game_manager):
        super().__init__(game_manager)
        
        # KHAI BÃO CÃC RECT Táº M THá»œI 
        self.start_button_rect = pygame.Rect(0, 0, 1, 1)
        self.assets = self._load_assets()
        
        # CÄ‚N CHá»ˆNH Vá»Š TRÃ NÃšT PLAY CUá»I CÃ™NG
        self.start_button_rect.center = (SCREEN_WIDTH // 2, SCREEN_HEIGHT // 2 + 180)
```

**Giáº£i thÃ­ch**:
- `start_button_rect`: Rect táº¡m thá»i (0, 0, 1, 1), Ä‘Æ°á»£c resize sau khi load áº£nh
- Vá»‹ trÃ­ nÃºt: CÄƒn giá»¯a mÃ n hÃ¬nh, d dá»‹ch xuá»‘ng 180px

#### 2.7.2. Load assets vá»›i fallback

```python
def _load_assets(self):
    assets = {}
    try:
        assets['nen_home'] = pygame.image.load(os.path.join(ASSETS_IMG_DIR, 'giaodiendautien.png')).convert_alpha()
        assets['nen_home'] = pygame.transform.scale(assets['nen_home'], (SCREEN_WIDTH, SCREEN_HEIGHT))     
        assets['nutbatdau'] = pygame.image.load(os.path.join(ASSETS_IMG_DIR, 'nutbatdau.png')).convert_alpha()
        assets['nutbatdau'] = pygame.transform.scale(assets['nutbatdau'], (250, 50)) 
        self.start_button_rect.size = assets['nutbatdau'].get_size() 
        
    except pygame.error as e:
        print(f"Lá»—i táº£i hÃ¬nh áº£nh Home: {e}. Vui lÃ²ng kiá»ƒm tra file áº£nh.")
        # Fallback: Táº¡o surface mÃ u Ä‘Æ¡n giáº£n
        assets['nen_home'] = pygame.Surface((SCREEN_WIDTH, SCREEN_HEIGHT))
        assets['nen_home'].fill(COLOR_BG)
        assets['nutbatdau'] = pygame.Surface((250, 50))
        assets['nutbatdau'].fill(COLOR_CORRECT)
        
    return assets
```

**Äiá»ƒm ná»•i báº­t**:
- Automatic fallback: Náº¿u load file áº£nh lá»—i, táº¡o surface mÃ u Ä‘Æ¡n giáº£n
- Scale tá»± Ä‘á»™ng: Ná»n fit toÃ n mÃ n hÃ¬nh (1200Ã—600)
- NÃºt resize: 250Ã—50 pixels

#### 2.7.3. Xá»­ lÃ½ click vá»›i fade transition

```python
def handle_input(self, event):
    if event.type == pygame.MOUSEBUTTONDOWN:
        mouse_pos = event.pos
        
        if self.start_button_rect.collidepoint(mouse_pos):
            # PhÃ¡t Ã¢m click
            self.game_manager.sounds['click'].play()
            
            # Fade transition sang Level Select
            self.game_manager.effect_manager.fade_transition(
                callback=lambda: self.game_manager.switch_screen("LEVEL"),
                fade_out_duration=0.2,
                fade_in_duration=0.2
            )
```

**Giáº£i thÃ­ch**:
- Kiá»ƒm tra collision: `collidepoint(mouse_pos)`
- Effect Manager: Gá»i `fade_transition()` vá»›i callback
- Callback: `lambda: self.game_manager.switch_screen("LEVEL")` - chuyá»ƒn mÃ n
- Duration: 0.2s fade out + 0.2s fade in = 0.4s total

---

### 2.8. Module Effect Manager (`src/effects/effect_manager.py`)

**Vai trÃ²**: Quáº£n lÃ½ hiá»‡u á»©ng chuyá»ƒn cáº£nh - 439 dÃ²ng code, Singleton pattern

#### 2.8.1. Khá»Ÿi táº¡o Effect Manager (Singleton)

```python
class EffectManager:
    """Singleton Effect Manager - Quáº£n lÃ½ táº¥t cáº£ transitions vÃ  effects."""
    _instance = None
    
    def __init__(self, screen_size=(1200, 600)):
        self.screen_size = screen_size
        self.screen_width, self.screen_height = screen_size
        
        # Transition hiá»‡n táº¡i
        self.current_transition = None
        self.transition_callback = None
        
        # Danh sÃ¡ch pending callbacks
        self.pending_callbacks = []
```

**Giáº£i thÃ­ch Singleton**:
- `_instance`: Class variable lÆ°u instance duy nháº¥t
- `get_instance()`: Táº¡o hoáº·c tráº£ vá» instance duy nháº¥t
- Táº¡i sao Singleton? Chá»‰ 1 effect manager cho toÃ n bá»™ game

#### 2.8.2. Fade Transition - Chuyá»ƒn cáº£nh mÆ°á»£t mÃ 

```python
def fade_transition(self, 
                   callback: Optional[Callable] = None,
                   fade_out_duration: Optional[float] = None,
                   fade_in_duration: Optional[float] = None,
                   color: Tuple[int, int, int] = (0, 0, 0)):
    """
    Full fade transition: fade out -> callback -> fade in.
    
    Tá»± Ä‘á»™ng xá»­ lÃ½ fade out, gá»i callback (chuyá»ƒn mÃ n), rá»“i fade in.
    """
    
    fade_out_dur = fade_out_duration if fade_out_duration is not None else 0.3
    fade_in_dur = fade_in_duration if fade_in_duration is not None else 0.3
    
    # Táº¡o fade transition
    self.current_transition = FadeTransition(
        screen_size=self.screen_size,
        fade_in=False,  # Báº¯t Ä‘áº§u vá»›i fade out
        duration=fade_out_dur,
        color=color
    )
    
    # LÆ°u callback Ä‘á»ƒ gá»i sau fade out
    if callback:
        self.pending_callbacks.append({
            'callback': callback,
            'fade_in_duration': fade_in_dur,
            'color': color  
        })
```

**Äiá»ƒm quan trá»ng**:
- 3 giai Ä‘oáº¡n: Fade out (tá»‘i dáº§n) â†’ Callback (chuyá»ƒn mÃ n) â†’ Fade in (sÃ¡ng dáº§n)
- `pending_callbacks`: Queue chá»©a callback chá» thá»±c thi
- Default duration: 0.3s má»—i phase

#### 2.8.3. Slide Transition - TrÆ°á»£t mÃ n hÃ¬nh

```python
def slide_screen(self, direction: str = "left", 
                callback: Optional[Callable] = None,
                duration: Optional[float] = None):
    """
    Slide transition - mÃ n hÃ¬nh má»›i trÆ°á»£t vÃ o.
    
    Args:
        direction (str): "left", "right", "up", "down"
        callback (Callable): HÃ m gá»i ngay khi báº¯t Ä‘áº§u slide (Ä‘á»ƒ switch screen)
        duration (float): Thá»i gian slide (máº·c Ä‘á»‹nh 0.5)
    """
    
    duration = duration if duration is not None else 0.5
    
    # Gá»i callback NGAY (Ä‘á»ƒ switch screen trÆ°á»›c khi slide)
    if callback:
        callback()
    
    # Táº¡o slide transition
    self.current_transition = SlideTransition(
        screen_size=self.screen_size,
        direction=direction,
        duration=duration
    )
```

**Giáº£i thÃ­ch**:
- Callback Ä‘Æ°á»£c gá»i TRÆ¯á»šC khi slide (khÃ¡c vá»›i fade)
- Direction: 4 hÆ°á»›ng (left/right/up/down)
- MÃ n hÃ¬nh má»›i "trÆ°á»£t" vÃ o tá»« hÆ°á»›ng chá»‰ Ä‘á»‹nh

#### 2.8.4. Update vÃ  Draw loop

```python
def update(self, dt: float):
    """
    Update transition hiá»‡n táº¡i.
    
    Args:
        dt (float): Delta time (giÃ¢y)
    """
    if self.current_transition:
        self.current_transition.update(dt)
        
        # Náº¿u transition káº¿t thÃºc
        if self.current_transition.is_done():
            # Xá»­ lÃ½ pending callbacks (cho fade transition)
            if self.pending_callbacks:
                cb_data = self.pending_callbacks.pop(0)
                cb_data['callback']()  # Gá»i callback (switch screen)
                
                # Báº¯t Ä‘áº§u fade in
                self.current_transition = FadeTransition(
                    screen_size=self.screen_size,
                    fade_in=True,
                    duration=cb_data['fade_in_duration'],
                    color=cb_data['color']
                )
            else:
                self.current_transition = None

def draw(self, surface: pygame.Surface):
    """Váº½ transition lÃªn mÃ n hÃ¬nh."""
    if self.current_transition:
        self.current_transition.draw(surface)
```

**Workflow fade transition**:
1. **Frame 0**: Báº¯t Ä‘áº§u fade out
2. **Frame N**: Fade out xong â†’ Gá»i callback (switch screen) â†’ Báº¯t Ä‘áº§u fade in
3. **Frame M**: Fade in xong â†’ Clear transition

---

### 2.9. Module Load Sounds (`src/core/load_sounds.py`)

**Vai trÃ²**: Load Ã¢m thanh vÃ o bá»™ nhá»› - 17 dÃ²ng code, khá»Ÿi táº¡o audio system

#### 2.9.1. Khá»Ÿi táº¡o Pygame Mixer

```python
import pygame
import os
from src.config import *

pygame.mixer.init()
# Nháº¡c ná»n
pygame.mixer.music.load(os.path.join(ASSETS_SOUND_DIR, "nhacnen.mp3"))
```

**Giáº£i thÃ­ch**:
- `pygame.mixer.init()`: Khá»Ÿi táº¡o audio system
- `pygame.mixer.music`: KÃªnh riÃªng cho nháº¡c ná»n (chá»‰ 1 track duy nháº¥t)
- Load nháº¡c ná»n: `nhacnen.mp3` (khÃ´ng phÃ¡t ngay, phÃ¡t á»Ÿ GameManager)

#### 2.9.2. Load Sound Effects

```python
def _load_sound():
    sounds = {}
    sounds['click'] = pygame.mixer.Sound(os.path.join(ASSETS_SOUND_DIR, "click_dapan.wav"))
    sounds['no'] = pygame.mixer.Sound(os.path.join(ASSETS_SOUND_DIR, "no.mp3"))
    sounds['yes'] = pygame.mixer.Sound(os.path.join(ASSETS_SOUND_DIR, "yes.mp3"))
    
    return sounds
```

**Giáº£i thÃ­ch**:
- `pygame.mixer.Sound`: KÃªnh cho sound effects (phÃ¡t Ä‘á»“ng thá»i Ä‘Æ°á»£c nhiá»u sound)
- 3 sound effects:
  - `click`: Ã‚m click nÃºt (WAV format - latency tháº¥p)
  - `yes`: Ã‚m xÃ¡c nháº­n Ä‘Ãºng
  - `no`: Ã‚m xÃ¡c nháº­n sai
- Tráº£ vá» dictionary Ä‘á»ƒ truy cáº­p: `sounds['click'].play()`

#### 2.9.3. Sá»­ dá»¥ng trong GameManager

```python
class GameManager:
    sounds = _load_sound()  # Load sounds á»Ÿ class level
    
    def __init__(self):
        # ...
        pygame.mixer.music.play(loops=-1)  # PhÃ¡t nháº¡c ná»n láº·p vÃ´ háº¡n
```

**Äiá»ƒm ná»•i báº­t**:
- Load á»Ÿ class level: Chá»‰ load 1 láº§n cho toÃ n bá»™ game
- `loops=-1`: PhÃ¡t nháº¡c ná»n láº·p vÃ´ háº¡n
- CÃ¡c screen khÃ¡c truy cáº­p: `self.game_manager.sounds['click'].play()`

---

## 3. LUá»’NG HOáº T Äá»˜NG CHI TIáº¾T

DÆ°á»›i Ä‘Ã¢y lÃ  luá»“ng hoáº¡t Ä‘á»™ng tá»« khi khá»Ÿi Ä‘á»™ng Ä‘áº¿n khi káº¿t thÃºc game, chia thÃ nh 6 giai Ä‘oáº¡n:

### 3.1. Khá»Ÿi Äá»™ng **Game** (Startup)

1. User cháº¡y `python main.py`
2. `GameManager.__init__()`: Load save data, khá»Ÿi táº¡o screens, phÃ¡t nháº¡c ná»n
3. Hiá»ƒn thá»‹ `Home Screen`

### 3.2. Chá»n Level (Level Selection)

4. User click "Báº¯t Ä‘áº§u" â†’ Chuyá»ƒn sang `LevelSelectScreen`
5. Váº½ 6 level, kiá»ƒm tra khÃ³a:  `is_locked = (i > 0 and stars_data[i-1] == 0)`
6. User click Level 3 â†’ Set `current_level_key = "LEVEL_3"`

### 3.3. Táº¡o CÃ¢u Há»i (Question Generation)

7. `switch_screen("GAMEPLAY")` gá»i `get_level_3_questions(20)`
8. Nháº­n 20 cÃ¢u há»i â†’ LÆ°u vÃ o `questions_pool`
9. `on_enter()` â†’ `reset_game()` â†’ `load_next_question()`

### 3.4. VÃ²ng Láº·p ChÆ¡i (Game Loop - 20 cÃ¢u)

Má»—i frame (~120 FPS):
- **update()**: Äáº¿m timer, kiá»ƒm tra háº¿t giá», tá»± Ä‘á»™ng chuyá»ƒn cÃ¢u sau 1.5s
- **draw()**: Váº½ cÃ¢u há»i (dynamic resize), váº½ 4 Ä‘Ã¡p Ã¡n, váº½ timer
- **handle_input()**: Khi user click â†’ `process_answer()` â†’ +10 hoáº·c -5 Ä‘iá»ƒm

### 3.5. Káº¿t ThÃºc (Game Over)

10. Háº¿t 20 cÃ¢u â†’ `game_over = True`
11. `calculate_stars()`: TÃ­nh 0-3 sao dá»±a trÃªn % Ä‘iá»ƒm
12. `save_score()`: Kiá»ƒm tra perfect/new_best, lÆ°u vÃ o `save.json`
13. Váº½ mÃ n hÃ¬nh káº¿t quáº£: Ä‘iá»ƒm, sao, 2 nÃºt (Next/Replay)

### 3.6. Menu Settings (CÃ³ thá»ƒ má»Ÿ báº¥t ká»³ lÃºc nÃ o)

- Click Settings â†’ `show_settings = True` â†’ Váº½ popup overlay
- Toggle Sound/BGM â†’ `update()` Ä‘iá»u khiá»ƒn `set_volume()` / `pause()`/`unpause()`
- Click Home/Replay/X â†’ Thá»±c hiá»‡n hÃ nh Ä‘á»™ng tÆ°Æ¡ng á»©ng

---

## 4. ÄIá»‚M Ná»”I Báº¬T VÃ€ Ká»¸ THUáº¬T Äáº¶C BIá»†T

### 4.1. Dynamic UI Resizing - Tá»± giÃ£n kÃ­ch thÆ°á»›c theo ná»™i dung

- Khung cÃ¢u há»i vÃ  nÃºt Ä‘Ã¡p Ã¡n tá»± giÃ£n theo ná»™i dung  
- Parser toÃ¡n há»c tÃ­nh toÃ¡n kÃ­ch thÆ°á»›c tá»«ng pháº§n tá»­  
- Há»— trá»£ phÃ¢n sá»‘ cao, biá»ƒu thá»©c dÃ i

### 4.2. Non-blocking Feedback - Pháº£n há»“i khÃ´ng bá»‹ cháº·n

- DÃ¹ng `show_feedback_until` thay vÃ¬ `pygame.time.delay()`  
- Game váº«n cháº¡y mÆ°á»£t, timer váº«n Ä‘áº¿m Ä‘Æ°á»£c

### 4.3. Realtime Timer - Bá»™ Ä‘áº¿m thá»i gian thá»±c

- DÃ¹ng `time.time()` thay vÃ¬ Ä‘áº¿m frame  
- ChÃ­nh xÃ¡c, khÃ´ng bá»‹ áº£nh hÆ°á»Ÿng bá»Ÿi FPS

### 4.4. Conditional Shuffling - Trá»™n cÃ¢u há»i cÃ³ Ä‘iá»u kiá»‡n

- Level 5 (phÃ¢n sá»‘) giá»¯ nguyÃªn thá»© tá»± Ä‘Ã¡p Ã¡n báº±ng `answer_index`  
- CÃ¡c level khÃ¡c shuffle ngáº«u nhiÃªn

### 4.5. Level Unlocking System - Há»‡ thá»‘ng má»Ÿ khÃ³a theo cáº¥p Ä‘á»™

- Level chá»‰ má»Ÿ khi level trÆ°á»›c Ä‘áº¡t >= 1 sao  
- Táº¡o cáº£m giÃ¡c tiáº¿n triá»ƒn

### 4.6. Perfect vs New Best - Äiá»ƒm hoÃ n háº£o vÃ  Ä‘iá»ƒm cao nháº¥t

- `is_perfect`: 200/200 Ä‘iá»ƒm  
- `is_new_best`: PhÃ¡ ká»· lá»¥c (nhÆ°ng khÃ´ng perfect)  
- Hiá»ƒn thá»‹ áº£nh khÃ¡c nhau

### 4.7. Progress Bar - Thanh tiáº¿n trÃ¬nh

- Thanh tiáº¿n Ä‘á»™ vá»›i 3 má»‘c sao (50%, 75%, 95%)  
- Sao sÃ¡ng/tá»‘i theo tiáº¿n trÃ¬nh

### 4.8. Menu dáº¡ng Popup
- MenuScreen lÃ  overlay, khÃ´ng pháº£i screen riÃªng  
- Tiáº¿t kiá»‡m bá»™ nhá»›, UX tá»‘t hÆ¡n

---

## 5. Káº¾T LUáº¬N

**Smart Math** lÃ  má»™t á»©ng dá»¥ng game há»c toÃ¡n Ä‘Æ°á»£c thiáº¿t káº¿ vÃ  xÃ¢y dá»±ng hoÃ n chá»‰nh vá»›i:

1. **Kiáº¿n trÃºc rÃµ rÃ ng**: Module chÃ­nh phÃ¢n tÃ¡ch há»£p lÃ½  
2. **Code cháº¥t lÆ°á»£ng**: 668 dÃ²ng trong GameplayScreen xá»­ lÃ½ UI phá»©c táº¡p  
3. **UX xuáº¥t sáº¯c**: Dynamic resizing, non-blocking feedback, realtime timer  
4. **Logic game cháº·t cháº½**: Unlocking system, perfect/new best, conditional shuffling

**Thá»‘ng kÃª dá»± Ã¡n**:
- Tá»•ng sá»‘ file Python: 21 files
- Module lá»›n nháº¥t: `gameplay_screen.py` (668 dÃ²ng)
- Module phá»©c táº¡p nháº¥t: `gameplay_screen.py` (parsing, rendering, timing)
- Tá»•ng sá»‘ assets: 42 files (38 áº£nh + 4 Ã¢m thanh)

**HÆ°á»›ng phÃ¡t triá»ƒn**:
- Multiplayer mode
- Báº£ng xáº¿p háº¡ng trá»±c tuyáº¿n
- ThÃªm level 7-10 (logarit, hÃ¬nh há»c, ...)
- Animation hiá»‡u á»©ng Ä‘áº¹p hÆ¡n

---

**NhÃ³m phÃ¡t triá»ƒn**: NhÃ³m 15
**NgÃ y hoÃ n thÃ nh**: 3/1/2026  
**CÃ´ng nghá»‡**: Python 3.x + Pygame 2.x
